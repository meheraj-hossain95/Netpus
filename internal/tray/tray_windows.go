//go:build windows

package tray

import (
	"os"

	"github.com/energye/systray"
)

// Proper 16x16 32-bit ICO icon with visible network arrows (green up, orange down)
// This is a valid ICO file structure that Windows systray will display correctly
var defaultIcon = []byte{
	// ICO Header
	0x00, 0x00, // Reserved
	0x01, 0x00, // Image type: 1 = ICO
	0x01, 0x00, // Number of images: 1

	// ICO Directory Entry (16 bytes)
	0x10,       // Width: 16
	0x10,       // Height: 16
	0x00,       // Color palette: 0 = no palette
	0x00,       // Reserved
	0x01, 0x00, // Color planes: 1
	0x20, 0x00, // Bits per pixel: 32
	0x68, 0x04, 0x00, 0x00, // Image size: 1128 bytes
	0x16, 0x00, 0x00, 0x00, // Image offset: 22 bytes

	// BITMAPINFOHEADER (40 bytes)
	0x28, 0x00, 0x00, 0x00, // Header size: 40
	0x10, 0x00, 0x00, 0x00, // Width: 16
	0x20, 0x00, 0x00, 0x00, // Height: 32 (doubled for XOR + AND masks)
	0x01, 0x00, // Planes: 1
	0x20, 0x00, // Bits per pixel: 32
	0x00, 0x00, 0x00, 0x00, // Compression: none
	0x00, 0x04, 0x00, 0x00, // Image size
	0x00, 0x00, 0x00, 0x00, // X pixels per meter
	0x00, 0x00, 0x00, 0x00, // Y pixels per meter
	0x00, 0x00, 0x00, 0x00, // Colors used
	0x00, 0x00, 0x00, 0x00, // Important colors

	// Pixel data (16x16, BGRA format, bottom-to-top)
	// Row 16 (bottom) - empty
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 15 - orange download tip
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x64, 0xE5, 0xFF,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 14 - orange download
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF,
	0x1E, 0x64, 0xE5, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 13 - orange download wider
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF,
	0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 12 - orange download widest
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF,
	0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 11 - orange stem
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF,
	0x1E, 0x64, 0xE5, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 10 - orange stem
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x64, 0xE5, 0xFF, 0x1E, 0x64, 0xE5, 0xFF,
	0x1E, 0x64, 0xE5, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 9 - separator
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 8 - green stem
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF,
	0x4A, 0xB5, 0x4A, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 7 - green stem
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF,
	0x4A, 0xB5, 0x4A, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 6 - green arrow widest
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF,
	0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 5 - green arrow
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF,
	0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 4 - green arrow
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4A, 0xB5, 0x4A, 0xFF, 0x4A, 0xB5, 0x4A, 0xFF,
	0x4A, 0xB5, 0x4A, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 3 - green tip
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4A, 0xB5, 0x4A, 0xFF,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 2 - empty
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	// Row 1 (top) - empty
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	// AND mask (16x16 bits = 32 bytes, all zeros for full opacity)
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00,
}

// Tray represents the system tray icon
type Tray struct {
	app        interface{}
	menuShow   *systray.MenuItem
	menuHide   *systray.MenuItem
	menuPause  *systray.MenuItem
	menuResume *systray.MenuItem
	menuQuit   *systray.MenuItem
}

// AppInterface defines the required methods from the main app
type AppInterface interface {
	ShowWindow()
	HideWindow()
	PauseMonitoring()
	ResumeMonitoring()
	QuitApp()
}

// New creates a new Tray instance
func New(app interface{}) *Tray {
	return &Tray{
		app: app,
	}
}

// Setup initializes the system tray
func (t *Tray) Setup() {
	systray.Run(t.onReady, t.onExit)
}

// onReady is called when systray is ready
func (t *Tray) onReady() {
	// Set embedded icon
	systray.SetIcon(defaultIcon)
	systray.SetTitle("Netpus")
	systray.SetTooltip("Netpus Network Monitor")

	app, ok := t.app.(AppInterface)

	// Create menu items with click handlers
	t.menuShow = systray.AddMenuItem("Show Dashboard", "Show the main window")
	if ok {
		t.menuShow.Click(func() {
			app.ShowWindow()
		})
	}

	t.menuHide = systray.AddMenuItem("Hide Dashboard", "Hide the main window")
	if ok {
		t.menuHide.Click(func() {
			app.HideWindow()
		})
	}

	systray.AddSeparator()

	t.menuPause = systray.AddMenuItem("Pause Monitoring", "Pause network monitoring")
	if ok {
		t.menuPause.Click(func() {
			app.PauseMonitoring()
			t.menuPause.Hide()
			t.menuResume.Show()
		})
	}

	t.menuResume = systray.AddMenuItem("Resume Monitoring", "Resume network monitoring")
	t.menuResume.Hide() // Initially hidden
	if ok {
		t.menuResume.Click(func() {
			app.ResumeMonitoring()
			t.menuResume.Hide()
			t.menuPause.Show()
		})
	}

	systray.AddSeparator()

	t.menuQuit = systray.AddMenuItem("Quit", "Quit the application")
	if ok {
		t.menuQuit.Click(func() {
			app.QuitApp()
			systray.Quit()
			os.Exit(0)
		})
	}
}

// onExit is called when systray exits
func (t *Tray) onExit() {
	// Cleanup
}

// handleMenuClicks is no longer needed - using Click callbacks instead

// UpdateTooltip updates the tray icon tooltip
func (t *Tray) UpdateTooltip(text string) {
	systray.SetTooltip(text)
}

// UpdatePauseState updates the pause/resume menu items
func (t *Tray) UpdatePauseState(paused bool) {
	if paused {
		t.menuPause.Hide()
		t.menuResume.Show()
	} else {
		t.menuResume.Hide()
		t.menuPause.Show()
	}
}

// Destroy cleans up the tray icon
func (t *Tray) Destroy() {
	systray.Quit()
}

// ShowNotification shows a system notification (reserved for future use)
func (t *Tray) ShowNotification(title, message string) {
	// TODO: Implement notifications
}
